<!DOCTYPE html>
<html lang="en-US"> <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>AWS Events - Panther Docs</title> <meta name="Description" content="AWS events to Panther"> <link rel="shortcut icon" href="/panther-docs/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/panther-docs/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/panther-docs/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/panther-docs/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>AWS Events | Panther Docs</title> <meta name="generator" content="Jekyll v3.9.2"> <meta property="og:title" content="AWS Events"> <meta property="og:locale" content="en_US"> <meta name="description" content="AWS events to Panther"> <meta property="og:description" content="AWS events to Panther"> <link rel="canonical" href="https://openanswers.github.io/panther-docs/panther/sending-events/aws"> <meta property="og:url" content="https://openanswers.github.io/panther-docs/panther/sending-events/aws"> <meta property="og:site_name" content="Panther Docs"> <meta property="og:image" content="https://openanswers.github.io/panther-docs/img/aws-to-panther.png"> <meta property="og:type" content="website"> <meta name="twitter:card" content="summary_large_image"> <meta property="twitter:image" content="https://openanswers.github.io/panther-docs/img/aws-to-panther.png"> <meta property="twitter:title" content="AWS Events"> <meta name="twitter:site" content="@"> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"AWS events to Panther","headline":"AWS Events","image":"https://openanswers.github.io/panther-docs/img/aws-to-panther.png","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://openanswers.github.io/panther-docs/img/panther_logo_thin.png"}},"url":"https://openanswers.github.io/panther-docs/panther/sending-events/aws"}</script> <!-- End Jekyll SEO tag --> <meta name="openans.product" content="Panther"> <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet"> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewbox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewbox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewbox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewbox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewbox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="https://openanswers.github.io/panther-docs/" class="site-title lh-tight"> <div class="site-logo"></div> </a> <div style="padding-right: 10px;"> <a href="https://github.com/OpenAnswers" target="_blank"> <i class="icon-github"></i> </a> <a href="https://twitter.com/PantherMonitor1" target="_blank"> <i class="icon-twitter"></i> </a> </div> <a href="#" id="menu-button" class="site-button"> <svg viewbox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list">
<li class="nav-list-item"><a href="https://openanswers.github.io/panther-docs/" class="nav-list-link">Home</a></li>
<li class="nav-list-item"><a href="https://openanswers.github.io/panther-docs/panther/about" class="nav-list-link">About</a></li>
<li class="nav-list-item"><a href="https://openanswers.github.io/panther-docs/panther/getting-started" class="nav-list-link">Getting Started</a></li>
<li class="nav-list-item active">
<a href="#" class="nav-list-expander"><svg viewbox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://openanswers.github.io/panther-docs/panther/sending-events" class="nav-list-link">Sending Events to Panther</a><ul class="nav-list ">
<li class="nav-list-item "><a href="https://openanswers.github.io/panther-docs/panther/sending-events/rsyslog" class="nav-list-link">Rsyslog</a></li>
<li class="nav-list-item "><a href="https://openanswers.github.io/panther-docs/panther/sending-events/nxlog" class="nav-list-link">NXLog</a></li>
<li class="nav-list-item "><a href="https://openanswers.github.io/panther-docs/panther/sending-events/panther-api" class="nav-list-link">Panther API</a></li>
<li class="nav-list-item active"><a href="https://openanswers.github.io/panther-docs/panther/sending-events/aws" class="nav-list-link active">AWS Events</a></li>
</ul>
</li>
<li class="nav-list-item"><a href="https://openanswers.github.io/panther-docs/panther/dashboard" class="nav-list-link">Dashboard</a></li>
<li class="nav-list-item">
<a href="#" class="nav-list-expander"><svg viewbox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://openanswers.github.io/panther-docs/panther/console" class="nav-list-link">Console</a><ul class="nav-list "><li class="nav-list-item "><a href="https://openanswers.github.io/panther-docs/panther/console/shortcuts" class="nav-list-link">Keyboard Shortcuts</a></li></ul>
</li>
<li class="nav-list-item">
<a href="#" class="nav-list-expander"><svg viewbox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://openanswers.github.io/panther-docs/panther/rules" class="nav-list-link">Rules</a><ul class="nav-list ">
<li class="nav-list-item "><a href="https://openanswers.github.io/panther-docs/panther/rules/agent" class="nav-list-link">Agent rules</a></li>
<li class="nav-list-item "><a href="https://openanswers.github.io/panther-docs/panther/rules/global" class="nav-list-link">Server Global rules</a></li>
<li class="nav-list-item "><a href="https://openanswers.github.io/panther-docs/panther/rules/group" class="nav-list-link">Server Group rules</a></li>
<li class="nav-list-item "><a href="https://openanswers.github.io/panther-docs/panther/rules/schedules" class="nav-list-link">Event schedule selection</a></li>
<li class="nav-list-item "><a href="https://openanswers.github.io/panther-docs/panther/rules/selection" class="nav-list-link">Event selection</a></li>
<li class="nav-list-item "><a href="https://openanswers.github.io/panther-docs/panther/rules/yaml" class="nav-list-link">Rules file (YAML)</a></li>
</ul>
</li>
<li class="nav-list-item"><a href="https://openanswers.github.io/panther-docs/panther/views" class="nav-list-link">Views</a></li>
<li class="nav-list-item"><a href="https://openanswers.github.io/panther-docs/panther/api" class="nav-list-link">API Console</a></li>
<li class="nav-list-item"><a href="https://openanswers.github.io/panther-docs/panther/admin" class="nav-list-link">Admin</a></li>
<li class="nav-list-item"><a href="https://openanswers.github.io/panther-docs/panther/settings" class="nav-list-link">Settings</a></li>
<li class="nav-list-item"><a href="https://openanswers.github.io/panther-docs/panther/license" class="nav-list-link">License</a></li>
</ul> </nav> <footer class="site-footer"> © 2021 <a href="https://openanswers.co.uk" target="_blank">Open Answers</a> </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Type to Search" aria-label="Search Panther Docs" autocomplete="off"> <label for="search-input" class="search-label"><svg viewbox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="//openanswers.co.uk" class="site-button" target="_blank" rel="noopener noreferrer"> Open Answers </a> </li> <li class="aux-nav-list-item"> <a href="//app.panther.support" class="site-button" target="_blank" rel="noopener noreferrer"> app.panther.support </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="https://openanswers.github.io/panther-docs/panther/sending-events">Sending Events to Panther</a></li> <li class="breadcrumb-nav-list-item"><span>AWS Events</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <div id="markdown-content">
<ul id="toc" class="section-nav"> <li class="toc-entry toc-h1">
<a href="#aws-events2panther">AWS-Events2Panther</a> <ul> <li class="toc-entry toc-h2"><a href="#system-design">System Design</a></li> </ul> </li> <li class="toc-entry toc-h1">
<a href="#step-by-step">Step-by-step</a> <ul> <li class="toc-entry toc-h2"><a href="#installing-sam-on-linux">Installing SAM on Linux</a></li> <li class="toc-entry toc-h2"><a href="#checklist">Checklist</a></li> <li class="toc-entry toc-h2">
<a href="#installing-aws-events2panther">Installing AWS-Events2Panther</a> <ul> <li class="toc-entry toc-h3"><a href="#building-the-aws-lambda-function-using-nodejs">Building the AWS Lambda function (using Node.js)</a></li> <li class="toc-entry toc-h3"><a href="#building-the-aws-lambda-function-using-docker">Building the AWS Lambda function (using Docker)</a></li> <li class="toc-entry toc-h3"><a href="#deploying-the-aws-lambda-function">Deploying the AWS Lambda function</a></li> </ul> </li> <li class="toc-entry toc-h2"><a href="#running">Running</a></li> </ul> </li> <li class="toc-entry toc-h1">
<a href="#configuring-the-captured-events">Configuring the captured events</a> <ul> <li class="toc-entry toc-h2"><a href="#generating-new-event-triggers-using-sam">Generating new event triggers using SAM</a></li> <li class="toc-entry toc-h2"><a href="#setting-up-event-triggers-in-the-aws-console">Setting up event triggers in the AWS console</a></li> </ul> </li> <li class="toc-entry toc-h1">
<a href="#advanced-event-filtering">Advanced event filtering</a> <ul> <li class="toc-entry toc-h2"><a href="#all-events-from-multiple-services">All events from multiple services:</a></li> <li class="toc-entry toc-h2"><a href="#a-particular-event-type-from-a-service">A particular event type from a service:</a></li> <li class="toc-entry toc-h2"><a href="#ec2-instance-state-change">EC2 instance state change</a></li> <li class="toc-entry toc-h2"><a href="#filtering-more-complex-events">Filtering more complex events</a></li> </ul> </li> <li class="toc-entry toc-h1">
<a href="#configuring-the-messages-sent-to-panther">Configuring the messages sent to Panther</a> <ul> <li class="toc-entry toc-h2"><a href="#currently-supported-event-types">Currently supported event types</a></li> <li class="toc-entry toc-h2"><a href="#panther-json-message">Panther JSON message</a></li> <li class="toc-entry toc-h2"><a href="#testing-changes-locally">Testing changes locally</a></li> <li class="toc-entry toc-h2"><a href="#checking-the-logs-in-aws">Checking the logs in AWS</a></li> </ul> </li> <li class="toc-entry toc-h1">
<a href="#sending-some-test-events">Sending some test events</a> <ul> <li class="toc-entry toc-h2">
<a href="#simulating-an-ec2-instance-state-change">Simulating an EC2 instance state change</a> <ul> <li class="toc-entry toc-h3"><a href="#sample-test-data">Sample test data</a></li> <li class="toc-entry toc-h3"><a href="#sending-a-sample-event">Sending a sample event</a></li> </ul> </li> </ul> </li> <li class="toc-entry toc-h1"><a href="#uninstalling">Uninstalling</a></li> </ul> <h1 id="aws-events2panther"> <a href="#aws-events2panther" class="anchor-heading" aria-labelledby="aws-events2panther"><svg viewbox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a class="anchor" href="#aws-events2panther" aria-hidden="true"><span class="octicon octicon-link"></span></a>AWS-Events2Panther </h1> <p>This guide will quickly and easily allow a user to deploy an <a href="https://aws.amazon.com/lambda/" target="_blank">AWS Lambda</a> function called AWS-Events2Panther to collect AWS events and send them to Panther using the <a href="/panther-docs/panther/api">Panther REST API</a>, which is a general purpose API that can also be used from the command-line.</p> <p>AWS events are either region specific or global, depending on the service. Therefore, to get all events to your Panther Console you will have to deploy the AWS-Events2Panther Lambda function to each of your accounts and regions that you wish to monitor.</p> <p>The AWS-Events2Panther Lambda function <a href="https://github.com/OpenAnswers/panther-aws-events/blob/master/e2p/e2p.js" target="_blank">Node.js JavaScript code</a> can be easily modified to support different AWS events, and/or send different data as part of the message, if required ( <a href="https://github.com/OpenAnswers/panther-aws-events/pulls" target="_blank">Pull Requests</a> welcome ).</p> <p>Events can be sent to either an <a href="https://app.panther.support" target="_blank">app.panther.support</a> SaaS instance or your own self-hosted <a href="https://hub.docker.com/repository/docker/openanswers/panther-console" target="_blank">Dockerised container</a> deployment.</p> <blockquote> <p><em><strong>NOTE:</strong> If you are self-hosting Panther through a local <code class="language-plaintext highlighter-rouge">docker</code> installation, you will need to ensure there is network connectivity from AWS to Panther. It is assumed there will be a TLS reverse proxy sat in front of Panther, if this not the case the Lambda function will need to be modified</em></p> </blockquote> <h2 id="system-design"> <a href="#system-design" class="anchor-heading" aria-labelledby="system-design"><svg viewbox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a class="anchor" href="#system-design" aria-hidden="true"><span class="octicon octicon-link"></span></a>System Design </h2> <p>This system has been designed to gather AWS events, extract data from them and send it to your Panther Console via the Panther API.</p> <p>The general flow of events from AWS to Panther is summarised by the following:</p> <p style="text-align: center;"><img src="/panther-docs/panther/sending-events/media/aws-to-panther.png" alt="AWSEvents2Panther"></p> <ol> <li>The Lambda function is triggered whenever a filter matches an event.</li> <li>The Lambda function formats the event data into a <a href="#panther-json-message">Panther JSON</a> message.</li> <li>The Lambda function sends the message to your Panther Console via the Panther API (over HTTPS) using your private <a href="/panther-docs/panther/api#api-key">API key</a>.</li> </ol> <h1 id="step-by-step"> <a href="#step-by-step" class="anchor-heading" aria-labelledby="step-by-step"><svg viewbox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a class="anchor" href="#step-by-step" aria-hidden="true"><span class="octicon octicon-link"></span></a>Step-by-step </h1> <p>The <a href="https://github.com/OpenAnswers/panther-aws-events" target="_blank">panther-aws-events</a> project is built and deployed to AWS using the Serverless Application Model (SAM):</p> <p><a href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/what-is-sam.html" target="_blank">docs.aws.amazon.com/serverless-application-model/latest/developerguide/what-is-sam.html</a></p> <p>Therefore, to easily build and deploy the Lambda function code to AWS, you must first install SAM.</p> <blockquote> <p><em><strong>NOTE:</strong> The AWS SAM tool requires that you have first setup the AWS CLI tools, and that you can use them to access your account. Amazon/AWS setup instructions will guide you through this process <a href="https://docs.aws.amazon.com/cli/index.html" target="_blank">docs.aws.amazon.com/cli/index.html</a></em></p> </blockquote> <h2 id="installing-sam-on-linux"> <a href="#installing-sam-on-linux" class="anchor-heading" aria-labelledby="installing-sam-on-linux"><svg viewbox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a class="anchor" href="#installing-sam-on-linux" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installing SAM on Linux </h2> <p>To install SAM on Linux, you can use the <a href="https://docs.python.org/3/installing/index.html" target="_blank">Python 3 installer</a> version:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip3 install aws-sam-cli
</code></pre></div></div> <p>The official <a href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html">Amazon SAM</a> install guide covers Windows, macOS and Linux and is slightly more involved.</p> <h2 id="checklist"> <a href="#checklist" class="anchor-heading" aria-labelledby="checklist"><svg viewbox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a class="anchor" href="#checklist" aria-hidden="true"><span class="octicon octicon-link"></span></a>Checklist </h2> <p>In order to send events from your AWS estate to <a href="https://app.panther.support" target="_blank">Panther</a> you will need to have the following values:</p> <div class="table-wrapper"><table> <tbody> <tr> <td><code class="language-plaintext highlighter-rouge">APIToken</code></td> <td>Panther <a href="/panther-docs/panther/admin#api-keys">HTTP API Key</a> this will be a long 32 character string of random letters and numbers</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">APIUrl</code></td> <td>Panther <a href="/panther-docs/panther/api">Event API URL</a> e.g. <a href="https://app.panther.support" target="_blank">https://example.app.panther.support/api/event/create</a> or self-hosted API endpoint</td> </tr> </tbody> </table></div> <p>You will be prompted for these values when deploying to AWS via SAM.</p> <h2 id="installing-aws-events2panther"> <a href="#installing-aws-events2panther" class="anchor-heading" aria-labelledby="installing-aws-events2panther"><svg viewbox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a class="anchor" href="#installing-aws-events2panther" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installing AWS-Events2Panther </h2> <p>Download the <a href="https://github.com/OpenAnswers/panther-aws-events" target="_blank">panther-aws-events</a> source code from GitHub with:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/OpenAnswers/panther-aws-events.git
cd panther-aws-events
</code></pre></div></div> <p>Once the source code has been downloaded, the <a href="https://github.com/OpenAnswers/panther-aws-events" target="_blank">panther-aws-events</a> project needs to be built using the <code class="language-plaintext highlighter-rouge">sam build</code> command. The panther-aws-events build is dependent on Node.js v12. To build the panther-aws-events project, you need to either install Node.js v12 locally or use the <code class="language-plaintext highlighter-rouge">sam build --use-container</code> option, which uses an Amazon provided AWS SAM Node.js v12 build container, as detailed below.</p> <h3 id="building-the-aws-lambda-function-using-nodejs"> <a href="#building-the-aws-lambda-function-using-nodejs" class="anchor-heading" aria-labelledby="building-the-aws-lambda-function-using-nodejs"><svg viewbox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a class="anchor" href="#building-the-aws-lambda-function-using-nodejs" aria-hidden="true"><span class="octicon octicon-link"></span></a>Building the AWS Lambda function (using Node.js) </h3> <p>If you have <code class="language-plaintext highlighter-rouge">node</code> v12 installed, you can use this build step:</p> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">#</span><span class="w"> </span>Build a Node.js 12 application using a locally installed version of Node.js
<span class="go">sam build
</span></code></pre></div></div> <blockquote> <p><em><strong>NOTE:</strong> Many linux distributions include an old version of <code class="language-plaintext highlighter-rouge">node</code>. Node.js v12 can be installed for Linux using <a href="https://github.com/nvm-sh/nvm" target="blank">NVM</a>.</em></p> </blockquote> <h3 id="building-the-aws-lambda-function-using-docker"> <a href="#building-the-aws-lambda-function-using-docker" class="anchor-heading" aria-labelledby="building-the-aws-lambda-function-using-docker"><svg viewbox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a class="anchor" href="#building-the-aws-lambda-function-using-docker" aria-hidden="true"><span class="octicon octicon-link"></span></a>Building the AWS Lambda function (using Docker) </h3> <p>If you have <code class="language-plaintext highlighter-rouge">docker</code> installed, you can use this build step, which has the advantage of being platform agnostic:</p> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">#</span><span class="w"> </span>Build a Node.js 12 application using an Amazon container image pulled from DockerHub
<span class="go">sam build --use-container --build-image amazon/aws-sam-cli-build-image-nodejs12.x
</span></code></pre></div></div> <h3 id="deploying-the-aws-lambda-function"> <a href="#deploying-the-aws-lambda-function" class="anchor-heading" aria-labelledby="deploying-the-aws-lambda-function"><svg viewbox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a class="anchor" href="#deploying-the-aws-lambda-function" aria-hidden="true"><span class="octicon octicon-link"></span></a>Deploying the AWS Lambda function </h3> <p>Using the guided option will interactively prompt for the values from the <a href="#checklist">checklist</a> above.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sam deploy --guided
</code></pre></div></div> <blockquote> <p><em><strong>NOTE:</strong> SAM uses the same configuration as the AWS CLI, so if you use many different accounts, ensure that your profile is pointing to the correct account that you wish to install the collector in.</em></p> </blockquote> <p>You will then be asked a series of questions to deploy the code to your account and will be prompted for the following values:</p> <ul> <li><code class="language-plaintext highlighter-rouge">APIToken</code></li> <li><code class="language-plaintext highlighter-rouge">APIUrl</code></li> </ul> <p>The process will look similar to this:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; sam deploy --guided

Configuring SAM deploy
======================

        Looking for samconfig.toml :  Found
        Reading default arguments  :  Success

        Setting default arguments for 'sam deploy'
        =========================================
        Stack Name [AWS-Events2Panther]:
        AWS Region [us-east-1]: eu-west-3
        Parameter APIToken []: XXXXXXXxxxxxxxxXXXXXXXxxxxxxXXXX
        Parameter APIUrl []: https://example.app.panther.support/api/event/create
        #Shows you resources changes to be deployed and require a 'Y' to initiate deploy
        Confirm changes before deploy [Y/n]: y
        #SAM needs permission to be able to create roles to connect to the resources in your template
        Allow SAM CLI IAM role creation [Y/n]: y
        Save arguments to samconfig.toml [Y/n]: y

        Looking for resources needed for deployment: Not found.
        Creating the required resources...
        Successfully created!

                Managed S3 bucket: aws-sam-cli-managed-default-samclisourcebucket-1f8nf3gegbbkw
                A different default S3 bucket can be set in samconfig.toml

        Saved arguments to config file
        Running 'sam deploy' for future deployments will use the parameters saved above.
        The above parameters can be changed by modifying samconfig.toml
        Learn more about samconfig.toml syntax at
        https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-config.html

        Deploying with following values
        ===============================
        Stack name                 : AWS-Events2Panther
        Region                     : eu-west-3
        Confirm changeset          : True
        Deployment s3 bucket       : aws-sam-cli-managed-default-samclisourcebucket-1f8nf3gegbbkw
        Capabilities               : ["CAPABILITY_IAM"]
        Parameter overrides        : {'APIToken': 'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX', 'APIUrl': 'https://example.app.panther.support/api/event/create'}

Initiating deployment
=====================
Uploading to AWS-Events2Panther/137eca46a121660aff6a2546ca442e9c  128369 / 128369.0  (100.00%)
Uploading to AWS-Events2Panther/1c7e5fc5e3c565cd85c8bd192ea7b34e.template  1700 / 1700.0  (100.00%)

Waiting for changeset to be created..

CloudFormation stack changeset
---------------------------------------------------------------------------------------------------------
Operation                       LogicalResourceId                                 ResourceType
---------------------------------------------------------------------------------------------------------
+ Add                           Events2PantherFunctionAllEventsPermission         AWS::Lambda::Permission
+ Add                           Events2PantherFunctionAllEvents                   AWS::Events::Rule
+ Add                           Events2PantherFunctionRole                        AWS::IAM::Role
+ Add                           Events2PantherFunction                            AWS::Lambda::Function
+ Add                           Events2PantherLogGroup                            AWS::Logs::LogGroup
---------------------------------------------------------------------------------------------------------

Changeset created successfully. arn:aws:cloudformation:eu-west-3:787224169971:changeSet/samcli-deploy1580150955/b6085648-3f8c-41eb-aaac-136075652a08


Previewing CloudFormation changeset before deployment
======================================================
Deploy this changeset? [y/N]: y

2020-01-27 18:49:40 - Waiting for stack create/update to complete

CloudFormation events from changeset
--------------------------------------------------------------------------------------------------------------------------------------------------------
ResourceStatus                      ResourceType                            LogicalResourceId                                 ResourceStatusReason
--------------------------------------------------------------------------------------------------------------------------------------------------------
CREATE_IN_PROGRESS                  AWS::IAM::Role                          Events2PantherFunctionRole                        -
CREATE_IN_PROGRESS                  AWS::Logs::LogGroup                     Events2PantherLogGroup                            -
CREATE_IN_PROGRESS                  AWS::IAM::Role                          Events2PantherFunctionRole                        Resource creation Initiated
CREATE_COMPLETE                     AWS::Logs::LogGroup                     Events2PantherLogGroup                            -
CREATE_IN_PROGRESS                  AWS::Logs::LogGroup                     Events2PantherLogGroup                            Resource creation Initiated
CREATE_COMPLETE                     AWS::IAM::Role                          Events2PantherFunctionRole                        -
CREATE_IN_PROGRESS                  AWS::Lambda::Function                   Events2PantherFunction                            -
CREATE_IN_PROGRESS                  AWS::Lambda::Function                   Events2PantherFunction                            Resource creation Initiated
CREATE_COMPLETE                     AWS::Lambda::Function                   Events2PantherFunction                            -
CREATE_IN_PROGRESS                  AWS::Events::Rule                       Events2PantherFunctionAllEvents                   Resource creation Initiated
CREATE_IN_PROGRESS                  AWS::Events::Rule                       Events2PantherFunctionAllEvents                   -
CREATE_COMPLETE                     AWS::Events::Rule                       Events2PantherFunctionAllEvents                   -
CREATE_IN_PROGRESS                  AWS::Lambda::Permission                 Events2PantherFunctionAllEventsPermission         Resource creation Initiated
CREATE_IN_PROGRESS                  AWS::Lambda::Permission                 Events2PantherFunctionAllEventsPermission         -
CREATE_COMPLETE                     AWS::Lambda::Permission                 Events2PantherFunctionAllEventsPermission         -
CREATE_COMPLETE                     AWS::CloudFormation::Stack              AWS-Events2Panther                                -
--------------------------------------------------------------------------------------------------------------------------------------------------------

Stack AWS-Events2Panther outputs:
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
OutputKey-Description                                                                                    OutputValue                                                          
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Events2PantherFunctionIamRole - Implicit IAM Role created for the AWS Events to Panther function         arn:aws:iam::787224169971:role/AWS-Events2Panther-Events2PantherFunctionRole-WO1GMSJJVFP5
Events2PantherFunction - AWS Events to Panther Lambda Function ARN                                       arn:aws:lambda:eu-west-3:787224169971:function:AWS-Events2Panther    
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Successfully created/updated stack - AWS-Events2Panther in eu-west-3
</code></pre></div></div> <h2 id="running"> <a href="#running" class="anchor-heading" aria-labelledby="running"><svg viewbox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a class="anchor" href="#running" aria-hidden="true"><span class="octicon octicon-link"></span></a>Running </h2> <p>Once the code has been successfully registered in AWS, you should start seeing a stream of events into your Panther Console.</p> <p>Manual testing can be done by following the <a href="#sending-some-test-events"><strong>Sending some test events</strong></a> instructions.</p> <h1 id="configuring-the-captured-events"> <a href="#configuring-the-captured-events" class="anchor-heading" aria-labelledby="configuring-the-captured-events"><svg viewbox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a class="anchor" href="#configuring-the-captured-events" aria-hidden="true"><span class="octicon octicon-link"></span></a>Configuring the captured events </h1> <p>There are two approaches to configuring which events will trigger the Lambda function.</p> <ul> <li> <p><a href="#generating-new-event-triggers-using-sam">Adding new YAML config to the SAM template</a> (<code class="language-plaintext highlighter-rouge">template.yaml</code>) that will generate the triggers for you.</p> </li> <li> <p><a href="#setting-up-event-triggers-in-the-aws-console">Setting up new triggers in the AWS Console</a>.</p> </li> </ul> <p>Depending on your use case you may prefer either approach.</p> <h2 id="generating-new-event-triggers-using-sam"> <a href="#generating-new-event-triggers-using-sam" class="anchor-heading" aria-labelledby="generating-new-event-triggers-using-sam"><svg viewbox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a class="anchor" href="#generating-new-event-triggers-using-sam" aria-hidden="true"><span class="octicon octicon-link"></span></a>Generating new event triggers using SAM </h2> <p>In the Resources section of the SAM template (<code class="language-plaintext highlighter-rouge">template.yaml</code>), the PantherMessageProxyFunction contains a section called Events.</p> <p>You will see that an event trigger has been configured (commented out) that will trigger the Lambda function when a <em>CloudWatchEvent</em> is created that has a source value of aws.guardduty:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="na">GuardDuty</span><span class="pi">:</span>
      <span class="na">Type</span><span class="pi">:</span> <span class="s">CloudWatchEvent</span>
      <span class="na">Properties</span><span class="pi">:</span>
        <span class="na">Pattern</span><span class="pi">:</span>
          <span class="na">Source</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">aws.guardduty</span>
</code></pre></div></div> <p>This event pattern will specify the fields to match up when filtering the CloudWatchEvents.</p> <p>If the filter pattern matches that of the event JSON, it will trigger the function.</p> <p>If you wish to capture some events, you can uncomment the following line from the start of the <em>lambdaHandler</em> function in the <code class="language-plaintext highlighter-rouge">e2p/e2p.js</code> file:</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Event Received: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
</code></pre></div></div> <p>This will write the event JSON to the CloudWatch Logs log group related to the Lambda function.</p> <p>Some other examples of pattern filters are, any EC2 instances that are terminated:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="na">EC2Events</span><span class="pi">:</span>
      <span class="na">Type</span><span class="pi">:</span> <span class="s">CloudWatchEvent</span>
      <span class="na">Properties</span><span class="pi">:</span>
        <span class="na">Pattern</span><span class="pi">:</span>
          <span class="na">Source</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">aws.ec2</span>
          <span class="na">Detail</span><span class="pi">:</span>
            <span class="na">State</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">terminated</span>
</code></pre></div></div> <p>Or if you wish to match CloudFormation Lambda code deployment in eu-west-1 or eu-west-2, you could write a filter like this:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="na">LambdaUpdates</span><span class="pi">:</span>
      <span class="na">Type</span><span class="pi">:</span> <span class="s">CloudWatchEvent</span>
      <span class="na">Properties</span><span class="pi">:</span>
        <span class="na">Pattern</span><span class="pi">:</span>
          <span class="na">source</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">aws-lambda</span>
          <span class="na">Detail</span><span class="pi">:</span>
            <span class="na">AwsRegion</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">eu-west-1</span>
            <span class="pi">-</span> <span class="s">eu-west-2</span>
            <span class="na">UserAgent</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">cloudformation.amazonaws.com</span>
</code></pre></div></div> <p>AWS documentation to help you create more filters can be found here (although it’s in JSON):</p> <p><a href="https://docs.aws.amazon.com/eventbridge/latest/userguide/filtering-examples-structure.html" target="_blank">docs.aws.amazon.com/eventbridge/latest/userguide/filtering-examples-structure.html</a></p> <h2 id="setting-up-event-triggers-in-the-aws-console"> <a href="#setting-up-event-triggers-in-the-aws-console" class="anchor-heading" aria-labelledby="setting-up-event-triggers-in-the-aws-console"><svg viewbox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a class="anchor" href="#setting-up-event-triggers-in-the-aws-console" aria-hidden="true"><span class="octicon octicon-link"></span></a>Setting up event triggers in the AWS console </h2> <p>The SAM CloudFormation template includes a rule to accept all events, and send them to the Lambda function.</p> <p>However, you can also disable that one and create your own more specific rules.</p> <p>Rules can be accessed from two locations:</p> <p><a href="https://console.aws.amazon.com/cloudwatch/home" target="_blank">console.aws.amazon.com/cloudwatch/home</a></p> <p>Or here:</p> <p><a href="https://console.aws.amazon.com/events/home" target="_blank">console.aws.amazon.com/events/home</a></p> <p>On either page you should click on the ‘<strong>Create rule</strong>’ button.</p> <p>Under <strong>Define pattern</strong>, select <strong>Event pattern</strong>, then select <strong>Pre-defined pattern by service</strong>, select ‘<strong>AWS</strong>’, then select ‘<strong>All Services</strong>’. This will behave in the same way as CloudTrail, by passing all AWS events to the target.</p> <p>As shown below:</p> <p><img src="/panther-docs/panther/sending-events/media/aws-define-pattern.png" alt="Event pattern - AWS - All Services"></p> <p>Next, under <strong>Select targets</strong> ensure the target is set to ‘<strong>Lambda function</strong>’, and then select the function id for the one you uploaded. It will be in the format: AWS-Events2Panther-{stack name}</p> <p><img src="/panther-docs/panther/sending-events/media/aws-select-targets.png" alt="Select targets - lambda function"></p> <p>Once done, you can click on the <strong>Create</strong> button at the bottom of the page.</p> <h1 id="advanced-event-filtering"> <a href="#advanced-event-filtering" class="anchor-heading" aria-labelledby="advanced-event-filtering"><svg viewbox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a class="anchor" href="#advanced-event-filtering" aria-hidden="true"><span class="octicon octicon-link"></span></a>Advanced event filtering </h1> <p>If you wish to only send events to Panther for particular services, you can select ‘<strong>Custom pattern</strong>’, and paste in an event pattern.</p> <p><img src="/panther-docs/panther/sending-events/media/aws-define-custom-pattern.png" alt="example custom pattern"></p> <p><strong>Examples of patterns</strong></p> <h2 id="all-events-from-multiple-services"> <a href="#all-events-from-multiple-services" class="anchor-heading" aria-labelledby="all-events-from-multiple-services"><svg viewbox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a class="anchor" href="#all-events-from-multiple-services" aria-hidden="true"><span class="octicon octicon-link"></span></a>All events from multiple services: </h2> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"source"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"aws.apigateway"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"aws.ec2"</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <h2 id="a-particular-event-type-from-a-service"> <a href="#a-particular-event-type-from-a-service" class="anchor-heading" aria-labelledby="a-particular-event-type-from-a-service"><svg viewbox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a class="anchor" href="#a-particular-event-type-from-a-service" aria-hidden="true"><span class="octicon octicon-link"></span></a>A particular event type from a service: </h2> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"source"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"aws.ec2"</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"detail-type"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"EBS Snapshot Notification"</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <h2 id="ec2-instance-state-change"> <a href="#ec2-instance-state-change" class="anchor-heading" aria-labelledby="ec2-instance-state-change"><svg viewbox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a class="anchor" href="#ec2-instance-state-change" aria-hidden="true"><span class="octicon octicon-link"></span></a>EC2 instance state change </h2> <p>When an instance has been terminated</p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"source"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"aws.ec2"</span><span class="w"> </span><span class="p">],</span><span class="w">
  </span><span class="nl">"detail-type"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"EC2 Instance State-change Notification"</span><span class="w"> </span><span class="p">],</span><span class="w">
  </span><span class="nl">"detail"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"state"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"terminated"</span><span class="w"> </span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <h2 id="filtering-more-complex-events"> <a href="#filtering-more-complex-events" class="anchor-heading" aria-labelledby="filtering-more-complex-events"><svg viewbox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a class="anchor" href="#filtering-more-complex-events" aria-hidden="true"><span class="octicon octicon-link"></span></a>Filtering more complex events </h2> <p>Filtering of events can be much more complex, here is Amazons guide:</p> <p><a href="https://docs.aws.amazon.com/eventbridge/latest/userguide/filtering-examples-structure.html" target="_blank">docs.aws.amazon.com/eventbridge/latest/userguide/filtering-examples-structure.html</a></p> <p>You can setup multiple filter rules, each looking for a different type of event from different services that all have the same target Lambda function.</p> <h1 id="configuring-the-messages-sent-to-panther"> <a href="#configuring-the-messages-sent-to-panther" class="anchor-heading" aria-labelledby="configuring-the-messages-sent-to-panther"><svg viewbox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a class="anchor" href="#configuring-the-messages-sent-to-panther" aria-hidden="true"><span class="octicon octicon-link"></span></a>Configuring the messages sent to Panther </h1> <p>The messages sent to Panther are generated in the JavaScript Lambda function using the information extracted from the JSON AWS event data.</p> <p>Therefore, to edit the message generated for an event that is already handled, all you have to do is find the correct function and edit it to put the data you wish in the correct fields.</p> <h2 id="currently-supported-event-types"> <a href="#currently-supported-event-types" class="anchor-heading" aria-labelledby="currently-supported-event-types"><svg viewbox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a class="anchor" href="#currently-supported-event-types" aria-hidden="true"><span class="octicon octicon-link"></span></a>Currently supported event types </h2> <ul> <li><a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/events/EventTypes.html#events-for-services-not-listed" target="_blank">AWS API Call via CloudTrail</a></li> <li><a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/events/EventTypes.html#ec2_event_type" target="_blank">EC2 Instance State-change Notification</a></li> <li><a href="https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_findings_cloudwatch.html#guardduty_findings_cloudwatch_format" target="_blank">GuardDuty Finding</a></li> <li><a href="https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cwe-event-formats.html" target="_blank">Security Hub Findings</a></li> <li>Config Configuration Item Change</li> </ul> <p>To handle a new event type you should replicate the approach used for other events:</p> <ol> <li>Create a new function that accepts a JSON object representing the AWS event data.</li> <li>The source event may contain an array of child events, create one or more Panther message from the source data. The Panther message format can be seen below.</li> <li>Add a new case statement into the <code class="language-plaintext highlighter-rouge">exports.lambdaHandler()</code> function that calls your new function and puts the returned data into the <em>data</em> variable. The data must be an array of one or more Panther messages.</li> </ol> <h2 id="panther-json-message"> <a href="#panther-json-message" class="anchor-heading" aria-labelledby="panther-json-message"><svg viewbox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a class="anchor" href="#panther-json-message" aria-hidden="true"><span class="octicon octicon-link"></span></a>Panther JSON message </h2> <p>The Panther JSON message has the following structure:</p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"event"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"node"</span><span class="p">:</span><span class="w"> </span><span class="s2">"thing being monitored"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"tag"</span><span class="p">:</span><span class="w"> </span><span class="s2">"A tag used for grouping"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"summary"</span><span class="p">:</span><span class="w"> </span><span class="s2">"A message used to describe the event"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"severity"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <p>The <code class="language-plaintext highlighter-rouge">severity</code> is on a scale from 0-5, with</p> <ul> <li>0=clear</li> <li>1=indeterminate</li> <li>2=warning,</li> <li>3=minor,</li> <li>4=major,</li> <li>5=critical</li> </ul> <h2 id="testing-changes-locally"> <a href="#testing-changes-locally" class="anchor-heading" aria-labelledby="testing-changes-locally"><svg viewbox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a class="anchor" href="#testing-changes-locally" aria-hidden="true"><span class="octicon octicon-link"></span></a>Testing changes locally </h2> <p>SAM can use a local Docker image to test Lambda functions on your machine.</p> <p>To run the Lambda function with the test data first update the <code class="language-plaintext highlighter-rouge">env.json</code> file with your values for <code class="language-plaintext highlighter-rouge">APIUrl</code> and <code class="language-plaintext highlighter-rouge">APIToken</code> as described in the <a href="#checklist">checklist</a>.</p> <blockquote> <p><em><strong>NOTE:</strong> To create a Panther <code class="language-plaintext highlighter-rouge">APIToken</code> please consult the <a href="/panther-docs/panther/admin#api-keys">admin documentation</a></em></p> </blockquote> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ cat env.json
{
  "Parameters": {
    "API_URL": "https://&lt;PANTHER_NAME&gt;.app.panther.support/api/event/create",
    "API_TOKEN": "&lt;PANTHER_API_TOKEN&gt;"
  }
}
</code></pre></div></div> <p>Then invoke the Lambda function with:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sam build
sam local invoke Events2PantherFunction -e events/&lt;filename&gt;.json --env-vars env.json
</code></pre></div></div> <p><strong>NOTE:</strong> Replace <code class="language-plaintext highlighter-rouge">&lt;filename&gt;.json</code> with an actual file, some examples are provided in the <a href="https://github.com/OpenAnswers/panther-aws-events/tree/master/events" target="_blank">GitHub repository</a>:</p> <ul> <li><a href="https://github.com/OpenAnswers/panther-aws-events/blob/master/events/guardduty1.json" target="_blank"><code class="language-plaintext highlighter-rouge">events/guardduty1.json</code></a></li> <li><a href="https://github.com/OpenAnswers/panther-aws-events/blob/master/events/guardduty2.json" target="_blank"><code class="language-plaintext highlighter-rouge">events/guardduty2.json</code></a></li> </ul> <p>Sample events can sometimes be found in the AWS documentation, or can be output to the console / CloudWatch Logs. The function will automatically output the event JSON when the processing code causes an exception, or a handler is not available for that particular type of event.</p> <h2 id="checking-the-logs-in-aws"> <a href="#checking-the-logs-in-aws" class="anchor-heading" aria-labelledby="checking-the-logs-in-aws"><svg viewbox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a class="anchor" href="#checking-the-logs-in-aws" aria-hidden="true"><span class="octicon octicon-link"></span></a>Checking the logs in AWS </h2> <p>Lambda functions produce log output that is put into a CloudWatch Log group.</p> <p>Navigate to: <a href="https://console.aws.amazon.com/cloudwatch/home#logsV2:log-groups" target="_blank">console.aws.amazon.com/cloudwatch/home</a></p> <p>Then look for the log group in the format: <code class="language-plaintext highlighter-rouge">/aws/lambda/AWS-Events2Panther</code></p> <p><img src="/panther-docs/panther/sending-events/media/aws-log-groups.png" alt="log groups"></p> <p>The log group will contain multiple logs written each time the function is triggered by an event.</p> <h1 id="sending-some-test-events"> <a href="#sending-some-test-events" class="anchor-heading" aria-labelledby="sending-some-test-events"><svg viewbox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a class="anchor" href="#sending-some-test-events" aria-hidden="true"><span class="octicon octicon-link"></span></a>Sending some test events </h1> <p>After installation has completed a new Lambda function will have been registered with the supplied <strong>Stack Name</strong> by default this will be called <strong>AWS-Events2Panther</strong>.</p> <h2 id="simulating-an-ec2-instance-state-change"> <a href="#simulating-an-ec2-instance-state-change" class="anchor-heading" aria-labelledby="simulating-an-ec2-instance-state-change"><svg viewbox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a class="anchor" href="#simulating-an-ec2-instance-state-change" aria-hidden="true"><span class="octicon octicon-link"></span></a>Simulating an EC2 instance state change </h2> <p>Find your Lambda function, if you imported with default values it will be named <strong>AWS-Events2Panther</strong> and should be listed on <a href="https://console.aws.amazon.com/lambda/home" target="_blank">aws.amazon.com/lambda/home</a></p> <p>You should see something like <img src="/panther-docs/panther/sending-events/media/aws-lambda-panther.png" alt="Default lambda function"></p> <h3 id="sample-test-data"> <a href="#sample-test-data" class="anchor-heading" aria-labelledby="sample-test-data"><svg viewbox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a class="anchor" href="#sample-test-data" aria-hidden="true"><span class="octicon octicon-link"></span></a>Sample test data </h3> <p>In order to test Events2Panther we’ll need some test data, you can copy the example data below, or provide your own.</p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
   </span><span class="nl">"id"</span><span class="p">:</span><span class="s2">"7bf73129-1428-4cd3-a780-95db273d1602"</span><span class="p">,</span><span class="w">
   </span><span class="nl">"detail-type"</span><span class="p">:</span><span class="s2">"EC2 Instance State-change Notification"</span><span class="p">,</span><span class="w">
   </span><span class="nl">"source"</span><span class="p">:</span><span class="s2">"aws.ec2"</span><span class="p">,</span><span class="w">
   </span><span class="nl">"account"</span><span class="p">:</span><span class="s2">"123456789012"</span><span class="p">,</span><span class="w">
   </span><span class="nl">"time"</span><span class="p">:</span><span class="s2">"2019-11-11T21:29:54Z"</span><span class="p">,</span><span class="w">
   </span><span class="nl">"region"</span><span class="p">:</span><span class="s2">"us-east-1"</span><span class="p">,</span><span class="w">
   </span><span class="nl">"resources"</span><span class="p">:[</span><span class="w">
      </span><span class="s2">"arn:aws:ec2:us-east-1:123456789012:instance/i-abcd1111"</span><span class="w">
   </span><span class="p">],</span><span class="w">
   </span><span class="nl">"detail"</span><span class="p">:{</span><span class="w">
      </span><span class="nl">"instance-id"</span><span class="p">:</span><span class="s2">"i-abcd1111"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"state"</span><span class="p">:</span><span class="s2">"pending"</span><span class="w">
   </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <p>It should look something like this:</p> <p><img src="/panther-docs/panther/sending-events/media/example-ec2-state-change.png" alt="example EC2 state change"></p> <h3 id="sending-a-sample-event"> <a href="#sending-a-sample-event" class="anchor-heading" aria-labelledby="sending-a-sample-event"><svg viewbox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a class="anchor" href="#sending-a-sample-event" aria-hidden="true"><span class="octicon octicon-link"></span></a>Sending a sample event </h3> <ul> <li> <p>Click the <img src="/panther-docs/panther/sending-events/media/test.png" alt="Test button"> button to send the event.</p> </li> <li> <p>Verify in your Panther Console that the event was received (it may take a couple of seconds)</p> </li> </ul> <p><img src="/panther-docs/panther/sending-events/media/example-ec2-in-panther.png" alt="EC2 event arrived in Panther"></p> <ul> <li>Repeat sending events, and the corresponding Panther Events tally will start increasing, e.g.</li> </ul> <p><img src="/panther-docs/panther/sending-events/media/example-ec2-in-panther-incremented.png" alt="EC2 event de-duplicated"></p> <h1 id="uninstalling"> <a href="#uninstalling" class="anchor-heading" aria-labelledby="uninstalling"><svg viewbox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a class="anchor" href="#uninstalling" aria-hidden="true"><span class="octicon octicon-link"></span></a>Uninstalling </h1> <p>If you wish to remove the CloudFormation stack that SAM creates you should run:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aws cloudformation delete-stack <span class="nt">--stack-name</span> AWS-Events2Panther <span class="nt">--region</span> &lt;aws region&gt;
</code></pre></div></div> </div> <hr> <footer> <div style="float: right"> <p class="text-small"> © 2022 <a href="https://openanswers.co.uk">Open Answers</a> </p> </div> <div class="d-flex mt-2"> <p class="text-small text-grey-dk-000 mb-0"> <a href="https://github.com/openanswers/panther-docs/tree/master/panther/sending-events/aws.md" id="edit-this-page">Edit this page on GitHub.</a> </p> </div> </footer> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
